<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω S·∫£n Ph·∫©m</title>
    <link rel="stylesheet" href="/stylesheets/style.css">
</head>
<body>
<%- include('../partials/navbar') %>
<div class="container">
    <h1>üõçÔ∏è Danh s√°ch s·∫£n ph·∫©m</h1>
    
    <!-- B·ªô l·ªçc v√† t√¨m ki·∫øm -->
    <div class="filter-section" style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
        <form action="/products" method="GET" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
            <!-- T√¨m ki·∫øm theo t√™n -->
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">üîç T√¨m ki·∫øm</label>
                <input type="text" name="search" value="<%= filters.search %>" 
                       placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..." 
                       style="width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>

            <!-- L·ªçc theo danh m·ª•c -->
            <div style="min-width: 180px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">üìÅ Danh m·ª•c</label>
                <select name="category" style="width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: white;">
                    <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                    <% categories.forEach(cat => { %>
                        <option value="<%= cat.id %>" <%= filters.category === cat.id ? 'selected' : '' %>><%= cat.name %></option>
                    <% }) %>
                </select>
            </div>

            <!-- L·ªçc theo kho·∫£ng gi√° -->
            <div style="min-width: 130px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">üí∞ Gi√° t·ª´</label>
                <input type="number" name="minPrice" value="<%= filters.minPrice %>" 
                       placeholder="0" min="0"
                       style="width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>
            <div style="min-width: 130px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">üí∞ Gi√° ƒë·∫øn</label>
                <input type="number" name="maxPrice" value="<%= filters.maxPrice %>" 
                       placeholder="‚àû" min="0"
                       style="width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
            </div>

            <!-- N√∫t t√¨m ki·∫øm v√† reset -->
            <div style="display: flex; gap: 10px;">
                <button type="submit" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    üîç T√¨m ki·∫øm
                </button>
                <a href="/products" style="padding: 10px 20px; background: #6c757d; color: white; border-radius: 8px; text-decoration: none; font-weight: 500;">
                    üîÑ Reset
                </a>
            </div>
        </form>
    </div>

    <!-- Th√¥ng tin k·∫øt qu·∫£ -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div style="color: #666;">
            <% if (filters.search || filters.category || filters.minPrice || filters.maxPrice) { %>
                T√¨m th·∫•y <strong><%= pagination.totalProducts %></strong> s·∫£n ph·∫©m
                <% if (filters.search) { %> v·ªõi t·ª´ kh√≥a "<strong><%= filters.search %></strong>"<% } %>
                <% if (filters.category && categoryMap[filters.category]) { %> trong danh m·ª•c "<strong><%= categoryMap[filters.category].name %></strong>"<% } %>
                <% if (filters.minPrice || filters.maxPrice) { %> 
                    gi√° 
                    <% if (filters.minPrice) { %>t·ª´ <strong><%= Number(filters.minPrice).toLocaleString('vi-VN') %>‚Ç´</strong><% } %>
                    <% if (filters.maxPrice) { %> ƒë·∫øn <strong><%= Number(filters.maxPrice).toLocaleString('vi-VN') %>‚Ç´</strong><% } %>
                <% } %>
            <% } else { %>
                T·ªïng c·ªông <strong><%= pagination.totalProducts %></strong> s·∫£n ph·∫©m
            <% } %>
        </div>
        <div style="display: flex; gap: 15px;">
            <% if (currentUser && currentUser.role === 'admin') { %>
                <a href="/products/add" class="add-btn">‚ûï Th√™m s·∫£n ph·∫©m m·ªõi</a>
                <a href="/products/deleted" class="add-btn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a5a);">üóëÔ∏è S·∫£n ph·∫©m ƒë√£ x√≥a</a>
            <% } %>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>·∫¢nh</th>
                <th>T√™n s·∫£n ph·∫©m</th>
                <th>Danh m·ª•c</th>
                <th>Gi√°</th>
                <th>T·ªìn kho</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>
            <% products.forEach(p => { %>
                <tr>
                    <td>
                        <% if (p.url_image) { %>
                            <img 
                                src="<%= p.url_image %>" 
                                width="80" 
                                alt="<%= p.name %>"
                                onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22monospace%22 font-size=%2214px%22 fill=%22%23999%22%3ENo Image%3C/text%3E%3C/svg%3E'; this.style.backgroundColor='#f0f0f0';"
                            />
                        <% } else { %>
                            <span style="color: #999; font-size: 40px;">üì¶</span>
                        <% } %>
                    </td>
                    <td><strong><%= p.name %></strong></td>
                    <td>
                        <% if (p.categoryId && categoryMap[p.categoryId]) { %>
                            <span style="padding: 4px 10px; background: #e8f5e9; color: #2e7d32; border-radius: 12px; font-size: 12px;">
                                üìÅ <%= categoryMap[p.categoryId].name %>
                            </span>
                        <% } else { %>
                            <span style="color: #999; font-size: 12px;">Ch∆∞a ph√¢n lo·∫°i</span>
                        <% } %>
                    </td>
                    <td><%= Number(p.price).toLocaleString('vi-VN') %>ƒë</td>
                    <td>
                        <% if (p.quantity === 0) { %>
                            <span style="background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                                ‚ùå H·∫øt h√†ng
                            </span>
                        <% } else if (p.quantity < 5) { %>
                            <span style="background: #fff3e0; color: #f57c00; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                                ‚ö†Ô∏è S·∫Øp h·∫øt (<%= p.quantity %>)
                            </span>
                        <% } else { %>
                            <span style="background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                                ‚úÖ C√≤n <%= p.quantity %>
                            </span>
                        <% } %>
                    </td>
                    <td>
                        <% if (currentUser && currentUser.role === 'admin') { %>
                            <a class="action-link" href="/products/edit/<%= p.id %>">‚úèÔ∏è S·ª≠a</a>
                            <form action="/products/delete/<%= p.id %>" method="post" style="display:inline">
                                <button type="submit" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')">üóëÔ∏è X√≥a</button>
                            </form>
                        <% } %>
                        <% if (p.quantity > 0) { %>
                            <form action="/cart/add" method="post" style="display:inline">
                                <input type="hidden" name="productId" value="<%= p.id %>">
                                <input type="hidden" name="quantity" value="1">
                                <button type="submit" style="background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                                    üõí Th√™m
                                </button>
                            </form>
                        <% } %>
                    </td>
                </tr>
            <% }) %>
        </tbody>
    </table>
    
    <% if (products.length === 0) { %>
        <div style="text-align: center; padding: 40px; color: #666;">
            <p style="font-size: 48px;">üì¶</p>
            <% if (filters.search || filters.category || filters.minPrice || filters.maxPrice) { %>
                <p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ph√π h·ª£p</p>
                <a href="/products" style="color: #667eea;">‚Üê Xem t·∫•t c·∫£ s·∫£n ph·∫©m</a>
            <% } else { %>
                <p>Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</p>
            <% } %>
        </div>
    <% } %>

    <!-- Ph√¢n trang -->
    <% if (pagination.totalPages > 1) { %>
        <div class="pagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; padding: 20px 0;">
            <% 
                // T·∫°o query string cho pagination
                const queryParams = new URLSearchParams();
                if (filters.search) queryParams.set('search', filters.search);
                if (filters.category) queryParams.set('category', filters.category);
                if (filters.minPrice) queryParams.set('minPrice', filters.minPrice);
                if (filters.maxPrice) queryParams.set('maxPrice', filters.maxPrice);
                const baseQuery = queryParams.toString() ? '&' + queryParams.toString() : '';
            %>
            
            <!-- N√∫t Previous -->
            <% if (pagination.hasPrev) { %>
                <a href="/products?page=<%= pagination.currentPage - 1 %><%= baseQuery %>" 
                   style="padding: 10px 15px; background: #667eea; color: white; border-radius: 8px; text-decoration: none;">
                    ‚Üê Tr∆∞·ªõc
                </a>
            <% } else { %>
                <span style="padding: 10px 15px; background: #e0e0e0; color: #999; border-radius: 8px;">‚Üê Tr∆∞·ªõc</span>
            <% } %>

            <!-- S·ªë trang -->
            <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                <% if (i === pagination.currentPage) { %>
                    <span style="padding: 10px 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 8px; font-weight: bold;">
                        <%= i %>
                    </span>
                <% } else if (i === 1 || i === pagination.totalPages || (i >= pagination.currentPage - 2 && i <= pagination.currentPage + 2)) { %>
                    <a href="/products?page=<%= i %><%= baseQuery %>" 
                       style="padding: 10px 15px; background: #f0f0f0; color: #333; border-radius: 8px; text-decoration: none;">
                        <%= i %>
                    </a>
                <% } else if (i === pagination.currentPage - 3 || i === pagination.currentPage + 3) { %>
                    <span style="color: #999;">...</span>
                <% } %>
            <% } %>

            <!-- N√∫t Next -->
            <% if (pagination.hasNext) { %>
                <a href="/products?page=<%= pagination.currentPage + 1 %><%= baseQuery %>" 
                   style="padding: 10px 15px; background: #667eea; color: white; border-radius: 8px; text-decoration: none;">
                    Sau ‚Üí
                </a>
            <% } else { %>
                <span style="padding: 10px 15px; background: #e0e0e0; color: #999; border-radius: 8px;">Sau ‚Üí</span>
            <% } %>
        </div>
        
        <div style="text-align: center; color: #666; font-size: 14px;">
            Trang <%= pagination.currentPage %> / <%= pagination.totalPages %> 
            (Hi·ªÉn th·ªã <%= products.length %> / <%= pagination.totalProducts %> s·∫£n ph·∫©m)
        </div>
    <% } %>
</div>
</body>
</html>
